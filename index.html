@app.post("/complete_payment")
async def complete_payment(payment_id: str, employee_address: str):
    try:
        with closing(sqlite3.connect(DB_PATH)) as conn:
            with closing(conn.cursor()) as cursor:
                cursor.execute("SELECT user_id, amount FROM frozen_balances WHERE payment_id = ? AND status = 'approved'", (payment_id,))
                payment = cursor.fetchone()
                if not payment:
                    raise HTTPException(status_code=400, detail="Payment not approved or not found")
                
                user_id, amount = payment
                usdt_amount = amount / 1.05  # Сумма без комиссии
                commission = amount - usdt_amount  # 5% комиссия
                
                cursor.execute("SELECT private_key, address FROM users WHERE user_id = ?", (user_id,))
                user_data = cursor.fetchone()
                sub_private_key_hex, sub_address = user_data
                sub_private_key = PrivateKey(bytes.fromhex(sub_private_key_hex))
                
                usdt_trc20_contract = tron_client.get_contract('TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t')
                tx = usdt_trc20_contract.functions.transfer(employee_address, int(usdt_amount * 10**6)).with_owner(sub_address).fee_limit(10000000).build().sign(sub_private_key).broadcast()
                tx_hash = tx['txid']
                
                cursor.execute("UPDATE users SET balance = balance - ? WHERE user_id = ?", (amount, user_id))
                cursor.execute("INSERT INTO transactions (user_id, type, amount, tx_id, timestamp) VALUES (?, ?, ?, ?, ?)",
                               (user_id, "payment", amount, tx_hash, int(time.time())))
                cursor.execute("DELETE FROM frozen_balances WHERE payment_id = ?", (payment_id,))
                conn.commit()
                
                logger.info(f"Completed payment {payment_id}: {usdt_amount} USDT to {employee_address}, commission {commission} USDT retained")
                return {"status": "completed", "tx_id": tx_hash}
    except Exception as e:
        logger.error(f"Error in complete_payment: {str(e)}")
        raise HTTPException(status_code=500, detail=str(e))